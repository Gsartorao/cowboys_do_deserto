<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cowboys do Deserto - Controle de Presen√ßa </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #262626; /* Dark warm gray */
        }
        .card {
            background-color: #404040; /* Lighter warm gray */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1rem; /* p-4 */
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            white-space: nowrap;
        }
        .btn-primary {
            background-color: #E87A24; /* Logo Orange */
            color: white;
        }
        .btn-primary:hover {
            background-color: #D46F20; /* Darker Orange */
        }
        .btn-danger {
             background-color: #A15C2F; /* Logo Brown */
             color: white;
        }
        .btn-danger:hover {
             background-color: #894E27; /* Darker Brown */
        }
        .btn-sm {
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
        }
        .input-field {
            background-color: #525252; /* Lighter gray for inputs */
            color: white;
            border: 1px solid #737373; /* Gray border */
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        input[type="date"].input-field {
            cursor: pointer;
        }
        /* Player item styles */
        .player-item {
            background-color: #525252; /* Lighter gray */
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            border: 1px solid transparent;
        }
        .player-item.confirmed {
            background-color: #404040; /* Card background */
            border-color: #E87A24; /* Logo Orange */
        }
        .confirm-btn, .unconfirm-btn {
            background-color: #737373;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .confirm-btn:hover {
            background-color: #D46F20; /* Darker Orange for hover */
        }
        .unconfirm-btn {
            background-color: #A15C2F; /* Logo Brown */
        }
        .unconfirm-btn:hover {
             background-color: #894E27;
        }
        .action-icon {
            background: none;
            border: none;
            color: #a3a3a3;
            cursor: pointer;
            padding: 0.25rem;
        }
        .action-icon:hover {
            color: #E87A24;
        }
        /* History collapsible styles */
        .history-content {
            display: none;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .history-content.expanded {
            display: block;
            max-height: 500px; /* Adjust as needed */
        }
        .history-arrow {
            transition: transform 0.3s ease-in-out;
        }
        .history-header.expanded .history-arrow {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="text-white min-h-screen p-4 sm:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-10 flex flex-col items-center justify-center">
            <img src="https://i.imgur.com/3Yd3s0w.jpeg" 
                 alt="Cowboys do Deserto Logo" 
                 class="h-24 mb-4"
                 onerror="this.onerror=null; this.src='https://placehold.co/300x120/E87A24/ffffff?text=Cowboys+do+Deserto';">
            <h1 class="text-4xl font-bold text-white">Cowboys do Deserto</h1>
            <p class="text-gray-400 mt-2">Controle de Presen√ßa</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <div class="space-y-8">
                <!-- Card: Pr√≥ximo Jogo -->
                <div class="card">
                    <h2 class="text-2xl font-bold mb-4 border-b border-gray-600 pb-2">üèê Pr√≥ximo Jogo</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="next-game-date" class="block text-sm font-medium text-gray-300 mb-1">Agendar data do jogo:</label>
                            <div class="flex gap-2">
                                <input type="date" id="next-game-date" class="input-field flex-grow">
                                <button id="schedule-game-btn" class="btn btn-primary">Agendar</button>
                            </div>
                        </div>
                        <div id="next-game-info" class="bg-gray-800 p-4 rounded-lg">
                             <p class="text-gray-400">Nenhum jogo agendado.</p>
                        </div>
                    </div>
                </div>

                <!-- Card: Gerenciar Jogadores -->
                <div class="card">
                    <h2 class="text-2xl font-bold mb-4 border-b border-gray-600 pb-2">‚≠ê Jogadores</h2>
                    <div class="space-y-4">
                        <div class="flex gap-2">
                            <input type="text" id="new-player-name" placeholder="Nome do novo jogador" class="input-field flex-grow">
                            <button id="add-player-btn" class="btn btn-primary">Adicionar</button>
                        </div>
                        <div id="players-list" class="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-80 overflow-y-auto pr-2">
                            <p class="text-gray-400 col-span-full">Carregando jogadores...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Coluna da Direita: Hist√≥rico -->
            <div class="card">
                <h2 class="text-2xl font-bold mb-4 border-b border-gray-600 pb-2">üìñ Hist√≥rico de Jogos</h2>
                <div id="game-history" class="space-y-4 max-h-[80vh] overflow-y-auto pr-2">
                    <p class="text-gray-400">Nenhum jogo no hist√≥rico.</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Status Message Area -->
    <div id="status-message" class="fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white text-center z-50 transform transition-transform translate-x-[200%]">
        Mensagem de Status
    </div>

    <script type="module">
        // Importa√ß√µes do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, addDoc, deleteDoc, query, where, Timestamp, updateDoc, deleteField, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configura√ß√£o do Firebase
        const firebaseConfig = {
                    apiKey: "AIzaSyBcotpxccLEKmiUD2DSdoBKBo6pkxf8R4U",
                    authDomain: "cowboys-do-deserto-volei.firebaseapp.com",
                    projectId: "cowboys-do-deserto-volei",
                    storageBucket: "cowboys-do-deserto-volei.firebasestorage.app",
                    messagingSenderId: "965988450529",
                    appId: "1:965988450529:web:a0c55317109a93ffd437a0"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'volei-app-default';

        // Inicializa√ß√£o do Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserId = null;

        // --- AUTENTICA√á√ÉO ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                loadInitialData();
            }
        });

        (async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Erro na autentica√ß√£o:", error);
                showStatusMessage(`Erro de Auth: ${error.message}`);
            }
        })();

        // --- REFER√äNCIAS DO FIRESTORE ---
        const playersCollection = collection(db, `artifacts/${appId}/public/data/players`);
        const gamesCollection = collection(db, `artifacts/${appId}/public/data/games`);
        
        // --- ELEMENTOS DO DOM ---
        const newPlayerNameInput = document.getElementById('new-player-name');
        const addPlayerBtn = document.getElementById('add-player-btn');
        const playersListDiv = document.getElementById('players-list');
        const nextGameDateInput = document.getElementById('next-game-date');
        const scheduleGameBtn = document.getElementById('schedule-game-btn');
        const nextGameInfoDiv = document.getElementById('next-game-info');
        const gameHistoryDiv = document.getElementById('game-history');
        const statusMessageDiv = document.getElementById('status-message');

        // --- VARI√ÅVEIS DE ESTADO ---
        let allPlayers = [];
        let currentScheduledGame = null; 

        // --- FUN√á√ïES DE UI ---
        function showStatusMessage(message, isError = true) {
            statusMessageDiv.textContent = message;
            statusMessageDiv.className = `fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white text-center z-50 transform transition-transform duration-300 ease-out ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            setTimeout(() => statusMessageDiv.classList.remove('translate-x-[200%]'), 10);
            setTimeout(() => statusMessageDiv.classList.add('translate-x-[200%]'), 4000);
        }

        // --- FUN√á√ïES DE RENDERIZA√á√ÉO ---
        function renderAll() {
            renderPlayers();
            renderNextGame();
        }

        function renderPlayers() {
            playersListDiv.innerHTML = '';
            if (allPlayers.length === 0) {
                playersListDiv.innerHTML = '<p class="text-gray-400 col-span-full">Nenhum jogador cadastrado.</p>';
                return;
            }

            const attendees = currentScheduledGame?.attendees || {};

            allPlayers.forEach(player => {
                const confirmation = attendees[player.id];
                const isConfirmed = !!confirmation;
                const playerEl = document.createElement('div');
                playerEl.id = `player-item-${player.id}`;
                playerEl.className = `player-item ${isConfirmed ? 'confirmed' : ''}`;
                
                let confirmationHtml = '';
                if (isConfirmed) {
                    const otherTime = confirmation.playingTime === '1 hora' ? '2 horas' : '1 hora';
                    confirmationHtml = `
                        <button class="confirm-btn" data-player-id="${player.id}" data-player-name="${player.name}" data-time="${otherTime}">Mudar p/ ${otherTime.split(' ')[0]}</button>
                        <button class="unconfirm-btn" data-player-id="${player.id}">Remover</button>
                    `;
                } else {
                    confirmationHtml = `
                        <button class="confirm-btn" data-player-id="${player.id}" data-player-name="${player.name}" data-time="1 hora">1h</button>
                        <button class="confirm-btn" data-player-id="${player.id}" data-player-name="${player.name}" data-time="2 horas">2h</button>
                    `;
                }

                playerEl.innerHTML = `
                    <div class="flex justify-between items-start">
                        <span class="player-name font-medium">${player.name} ${isConfirmed ? `(${confirmation.playingTime})` : ''}</span>
                        <div class="player-edit-form hidden">
                            <input type="text" value="${player.name}" class="input-field input-field-sm !p-1 !text-sm !w-full">
                        </div>
                        <div class="player-actions flex items-center gap-1">
                            <button class="action-icon edit-player-btn" data-player-id="${player.id}" title="Editar nome">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V12h2.293z"/></svg>
                            </button>
                            <button class="action-icon remove-player-btn" data-player-id="${player.id}" title="Remover jogador">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg>
                            </button>
                        </div>
                    </div>
                    <div class="confirmation-actions mt-2 flex items-center gap-2 text-xs">
                        ${confirmationHtml}
                    </div>
                `;
                playersListDiv.appendChild(playerEl);
            });
        }

        function renderNextGame() {
            nextGameInfoDiv.innerHTML = '';
            if (!currentScheduledGame) {
                nextGameInfoDiv.innerHTML = '<p class="text-gray-400">Nenhum jogo agendado.</p>';
                return;
            }
            const gameDate = currentScheduledGame.date.toDate();
            const formattedDate = gameDate.toLocaleString('pt-BR', { dateStyle: 'full' });
            const attendees = currentScheduledGame.attendees || {};
            const attendeesCount = Object.keys(attendees).length;
            const sortedAttendees = Object.values(attendees).sort((a, b) => a.name.localeCompare(b.name, 'pt-BR'));
            
            nextGameInfoDiv.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xl font-semibold" style="color: #E87A24;">${formattedDate}</h3>
                    <button data-game-id="${currentScheduledGame.id}" class="btn btn-danger btn-sm cancel-game-btn">Cancelar</button>
                </div>
                <div class="mt-4">
                    <h4 class="font-bold text-lg mb-2">Confirmados (${attendeesCount})</h4>
                    <div id="attendees-list" class="space-y-1 text-sm">
                        ${attendeesCount === 0 ? '<p class="text-gray-500">Ningu√©m confirmado ainda.</p>' : ''}
                        ${sortedAttendees.map(data => `
                            <div class="bg-gray-900 p-2 rounded flex justify-between">
                                <span>${data.name}</span>
                                <span class="font-semibold" style="color: ${data.playingTime === '2 horas' ? '#E87A24' : '#FBBF24'}">${data.playingTime}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
        }

        function renderGameHistory(games) {
            gameHistoryDiv.innerHTML = '';
            if (games.length === 0) {
                gameHistoryDiv.innerHTML = '<p class="text-gray-400">Nenhum jogo no hist√≥rico.</p>';
                return;
            }
            const sortedGames = games.sort((a, b) => b.date.toDate() - a.date.toDate());
            sortedGames.forEach(game => {
                const gameDate = game.date.toDate();
                const formattedDate = gameDate.toLocaleString('pt-BR', { dateStyle: 'long' });
                const attendees = game.attendees || {};
                const attendeesCount = Object.keys(attendees).length;

                const gameEl = document.createElement('div');
                gameEl.className = 'bg-gray-700 rounded-lg overflow-hidden';
                
                const sortedAttendees = Object.values(attendees).sort((a, b) => a.name.localeCompare(b.name, 'pt-BR'));

                const attendeesHtml = sortedAttendees.map(att => `
                    <div class="flex justify-between">
                        <span>${att.name}</span>
                        <span class="font-medium" style="color: ${att.playingTime === '2 horas' ? '#E87A24' : '#FBBF24'}">${att.playingTime}</span>
                    </div>
                `).join('') || '<p class="text-gray-500">Nenhum participante registrado.</p>';

                gameEl.innerHTML = `
                    <div class="history-header p-4 cursor-pointer flex justify-between items-center">
                        <div>
                            <h3 class="font-bold text-lg">${formattedDate}</h3>
                            <p class="text-sm text-gray-400">${attendeesCount} participantes</p>
                        </div>
                        <svg class="history-arrow w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                        </svg>
                    </div>
                    <div class="history-content px-4 pb-4 border-t border-gray-600">
                        <div class="space-y-1 text-sm mt-2">${attendeesHtml}</div>
                    </div>
                `;
                gameHistoryDiv.appendChild(gameEl);
            });
        }

        // --- L√ìGICA DO FIRESTORE ---
        function loadInitialData() {
            onSnapshot(playersCollection, (snapshot) => {
                allPlayers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allPlayers.sort((a, b) => a.name.localeCompare(b.name, 'pt-BR'));
                renderAll();
            });

            const nextGameQuery = query(gamesCollection, where("status", "==", "scheduled"));
            onSnapshot(nextGameQuery, (snapshot) => {
                currentScheduledGame = snapshot.docs.length > 0 ? { id: snapshot.docs[0].id, ...snapshot.docs[0].data() } : null;
                renderAll();
            });

            const historyQuery = query(gamesCollection, where("status", "==", "completed"));
            onSnapshot(historyQuery, (snapshot) => {
                renderGameHistory(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            });
        }
        
        // --- MANIPULADORES DE EVENTOS ---
        async function handleAddPlayer() {
            const name = newPlayerNameInput.value.trim();
            if (name) {
                try {
                    await addDoc(playersCollection, { name });
                    newPlayerNameInput.value = '';
                    showStatusMessage('Jogador adicionado!', false);
                } catch (error) {
                    console.error("Erro ao adicionar jogador:", error);
                    showStatusMessage(`Falha ao adicionar: ${error.message}`);
                }
            } else {
                showStatusMessage("O nome do jogador n√£o pode estar vazio.");
            }
        }

        addPlayerBtn.addEventListener('click', handleAddPlayer);
        newPlayerNameInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') handleAddPlayer();
        });

        playersListDiv.addEventListener('click', async (e) => {
            const target = e.target;
            const playerItem = target.closest('.player-item');
            if (!playerItem) return;

            const removeBtn = target.closest('.remove-player-btn');
            const editBtn = target.closest('.edit-player-btn');
            const confirmBtn = target.closest('.confirm-btn');
            const unconfirmBtn = target.closest('.unconfirm-btn');

            if (editBtn) {
                toggleEditMode(playerItem, true);
            } else if (removeBtn) {
                handleRemovePlayer(removeBtn.dataset.playerId);
            } else if (confirmBtn) {
                handleConfirmPresence(confirmBtn);
            } else if (unconfirmBtn) {
                handleUnconfirmPresence(unconfirmBtn);
            }
        });

        function toggleEditMode(playerItem, isEditing) {
            const nameSpan = playerItem.querySelector('.player-name');
            const editForm = playerItem.querySelector('.player-edit-form');
            const actions = playerItem.querySelector('.player-actions');
            const confirmActions = playerItem.querySelector('.confirmation-actions');

            if (isEditing) {
                nameSpan.classList.add('hidden');
                editForm.classList.remove('hidden');
                actions.classList.add('hidden');
                confirmActions.classList.add('hidden');

                const input = editForm.querySelector('input');
                input.focus();
                input.select();

                const saveBtn = document.createElement('button');
                saveBtn.className = 'action-icon save-edit-btn';
                saveBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425z"/></svg>`;
                
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'action-icon cancel-edit-btn';
                cancelBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/></svg>`;
                
                editForm.append(saveBtn, cancelBtn);

                const handleSave = () => handleSaveEdit(playerItem.id.split('-')[2], input.value);
                const handleCancel = () => toggleEditMode(playerItem, false);

                saveBtn.onclick = handleSave;
                cancelBtn.onclick = handleCancel;
                input.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleSave();
                    } else if (e.key === 'Escape') {
                        handleCancel();
                    }
                };
            } else {
                nameSpan.classList.remove('hidden');
                editForm.classList.add('hidden');
                actions.classList.remove('hidden');
                confirmActions.classList.remove('hidden');
                editForm.querySelector('.save-edit-btn')?.remove();
                editForm.querySelector('.cancel-edit-btn')?.remove();
            }
        }

        async function handleSaveEdit(playerId, newName) {
            const trimmedName = newName.trim();
            if (!trimmedName) {
                showStatusMessage("O nome n√£o pode ficar vazio.");
                return;
            }
            try {
                const batch = writeBatch(db);
                const playerRef = doc(db, `artifacts/${appId}/public/data/players`, playerId);
                batch.update(playerRef, { name: trimmedName });

                if (currentScheduledGame && currentScheduledGame.attendees[playerId]) {
                    const gameRef = doc(db, `artifacts/${appId}/public/data/games`, currentScheduledGame.id);
                    batch.update(gameRef, { [`attendees.${playerId}.name`]: trimmedName });
                }
                await batch.commit();
                showStatusMessage("Nome atualizado!", false);
            } catch (error) {
                console.error("Erro ao atualizar nome:", error);
                showStatusMessage(`Erro ao atualizar: ${error.message}`);
            } finally {
                const playerItem = document.getElementById(`player-item-${playerId}`);
                if (playerItem) toggleEditMode(playerItem, false);
            }
        }

        async function handleRemovePlayer(playerId) {
            try {
                const batch = writeBatch(db);
                const playerRef = doc(db, `artifacts/${appId}/public/data/players`, playerId);
                batch.delete(playerRef);

                if (currentScheduledGame && currentScheduledGame.attendees[playerId]) {
                    const gameRef = doc(db, `artifacts/${appId}/public/data/games`, currentScheduledGame.id);
                    batch.update(gameRef, { [`attendees.${playerId}`]: deleteField() });
                }
                await batch.commit();
                showStatusMessage('Jogador removido.', false);
            } catch (error) {
                console.error("Erro ao remover jogador:", error);
                showStatusMessage(`Falha ao remover: ${error.message}`);
            }
        }

        async function handleConfirmPresence(button) {
             if (!currentScheduledGame) {
                showStatusMessage('Agende um jogo antes de confirmar a presen√ßa.');
                return;
            }
            const { playerId, playerName, time } = button.dataset;
            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, currentScheduledGame.id);
            try {
                await updateDoc(gameRef, { [`attendees.${playerId}`]: { name: playerName, playingTime: time } });
            } catch (error) {
                 console.error("Erro ao confirmar presen√ßa:", error);
                 showStatusMessage(`Falha ao confirmar: ${error.message}`);
            }
        }
        
        async function handleUnconfirmPresence(button) {
            if (!currentScheduledGame) return;
            const { playerId } = button.dataset;
            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, currentScheduledGame.id);
            try {
                await updateDoc(gameRef, { [`attendees.${playerId}`]: deleteField() });
            } catch (error) {
                console.error("Erro ao remover presen√ßa:", error);
                showStatusMessage(`Falha ao remover presen√ßa: ${error.message}`);
            }
        }
        
        scheduleGameBtn.addEventListener('click', async () => {
            const dateValue = nextGameDateInput.value;
            if (!dateValue) {
                showStatusMessage('Por favor, selecione uma data para o jogo.');
                return;
            }
            const newGameDate = new Date(dateValue + 'T12:00:00');
            if (isNaN(newGameDate.getTime())) {
                 showStatusMessage('Data selecionada √© inv√°lida.');
                 return;
            }

            try {
                if (currentScheduledGame) {
                    const oldGameRef = doc(db, `artifacts/${appId}/public/data/games`, currentScheduledGame.id);
                    await updateDoc(oldGameRef, { status: "completed" });
                }
                await addDoc(gamesCollection, {
                    date: Timestamp.fromDate(newGameDate),
                    status: "scheduled",
                    attendees: {}
                });
                nextGameDateInput.value = '';
                showStatusMessage('Novo jogo agendado com sucesso!', false);
            } catch (error) {
                console.error("Erro ao agendar jogo:", error);
                showStatusMessage(`Falha ao agendar: ${error.message}`);
            }
        });
        
        nextGameDateInput.addEventListener('click', (e) => {
            try {
                e.target.showPicker();
            } catch (error) {
                // Not a critical error, just a UX improvement
            }
        });

        nextGameInfoDiv.addEventListener('click', async (e) => {
            if (e.target.closest('.cancel-game-btn')) {
                const gameId = e.target.closest('.cancel-game-btn').dataset.gameId;
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/games`, gameId));
                    showStatusMessage('Jogo cancelado com sucesso.', false);
                } catch (error) {
                    console.error("Erro ao cancelar jogo:", error);
                    showStatusMessage(`Falha ao cancelar: ${error.message}`);
                }
            }
        });

        gameHistoryDiv.addEventListener('click', (e) => {
            const header = e.target.closest('.history-header');
            if (header) {
                const content = header.nextElementSibling;
                if (content && content.classList.contains('history-content')) {
                    header.classList.toggle('expanded');
                    content.classList.toggle('expanded');
                }
            }
        });

    </script>
</body>
</html>

